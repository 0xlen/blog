<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.19.3 by Michael Rose
  Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>[AWS][EKS] Best practice for load balancing - 2. imbalanced problem - Continuous Improvement</title>
<meta name="description" content="This article is sharing the best practice for doing load balancing on Amazon EKS, learn what is advantage and disadvantage of using different controller. We will discuss more detail about the imbalanced problem after applying controller to deploy the Elastic Load Balancer.">


  <meta name="author" content="Yang-Xin Cao (Eason Cao)">


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Continuous Improvement">
<meta property="og:title" content="[AWS][EKS] Best practice for load balancing - 2. imbalanced problem">
<meta property="og:url" content="https://easoncao.com/eks-best-practice-load-balancing-2-en/">


  <meta property="og:description" content="This article is sharing the best practice for doing load balancing on Amazon EKS, learn what is advantage and disadvantage of using different controller. We will discuss more detail about the imbalanced problem after applying controller to deploy the Elastic Load Balancer.">



  <meta property="og:image" content="https://easoncao.com/assets/images/posts/2022/04/eks-best-practice-load-balancing/ip-target.png">





  <meta property="article:published_time" content="2022-04-08T00:00:00-05:00">





  

  


<link rel="canonical" href="https://easoncao.com/eks-best-practice-load-balancing-2-en/">




<script type="application/ld+json">
  {
    "@context": "https://schema.org",
    
      "@type": "Person",
      "name": "Continuous Improvement",
      "url": "https://easoncao.com/"
    
  }
</script>






<!-- end _includes/seo.html -->


<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Continuous Improvement Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- Google adsense -->
<script data-ad-client="ca-pub-1852752964062281" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css">

<!--[if IE]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<link rel="shortcut icon" type="image/jpg" href="/assets/apple-touch-icon.png"/>

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
          <a class="site-logo" href="/"><img src="/assets/apple-touch-icon.png" alt=""></a>
        
        <a class="site-title" href="/">
          Continuous Improvement
          <span class="site-subtitle"></span>
        </a>
        <ul class="visible-links"><li class="masthead__menu-item">
              <a href="/posts/">所有文章 All Posts</a>
            </li><li class="masthead__menu-item">
              <a href="/courses/">學習資源 Learning</a>
            </li><li class="masthead__menu-item">
              <a href="/about/">關於 About</a>
            </li></ul>
        
        <button class="search__toggle" type="button">
          <span class="visually-hidden">Toggle search</span>
          <svg class="icon" width="16" height="16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.99 16">
            <path d="M15.5,13.12L13.19,10.8a1.69,1.69,0,0,0-1.28-.55l-0.06-.06A6.5,6.5,0,0,0,5.77,0,6.5,6.5,0,0,0,2.46,11.59a6.47,6.47,0,0,0,7.74.26l0.05,0.05a1.65,1.65,0,0,0,.5,1.24l2.38,2.38A1.68,1.68,0,0,0,15.5,13.12ZM6.4,2A4.41,4.41,0,1,1,2,6.4,4.43,4.43,0,0,1,6.4,2Z" transform="translate(-.01)"></path>
          </svg>
        </button>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person">

  
    <div class="author__avatar">
      
        <img src="https://www.gravatar.com/avatar/0d33994eec9eddc67415e07a7fcafc9d?s=200" alt="Yang-Xin Cao (Eason Cao)" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">Yang-Xin Cao (Eason Cao)</h3>
    
    
      <div class="author__bio" itemprop="description">
        <p>Engineer@Amazon <br />- <a href="https://www.awshof.com/allstarscertifiedlist.html">AWS All-5 certified</a> / ECS &amp; EKS SME / Marathon Runner / PADI Open Water Diver</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name">Amazon / Dublin, Ireland</span>
        </li>
      

      
        
          
            <li><a href="mailto:eason@easoncao.com" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-envelope-square" aria-hidden="true"></i><span class="label">Email</span></a></li>
          
        
          
            <li><a href="https://linkedin.com/in/easoncao" rel="nofollow noopener noreferrer"><i class="fas fa-fw fa-id-badge" aria-hidden="true"></i><span class="label">LinkedIn</span></a></li>
          
        
          
        
          
            <li><a href="https://facebook.com/EasonTechTalk" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i><span class="label">Facebook</span></a></li>
          
        
          
            <li><a href="https://github.com/0xlen" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-github" aria-hidden="true"></i><span class="label">GitHub</span></a></li>
          
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="[AWS][EKS] Best practice for load balancing - 2. imbalanced problem">
    <meta itemprop="description" content="This article is sharing the best practice for doing load balancing on Amazon EKS, learn what is advantage and disadvantage of using different controller. We will discuss more detail about the imbalanced problem after applying controller to deploy the Elastic Load Balancer.">
    <meta itemprop="datePublished" content="2022-04-08T00:00:00-05:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">[AWS][EKS] Best practice for load balancing - 2. imbalanced problem
</h1>
          
            <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  9 minute read

</p>
          
        </header>
      

      <!-- Google ads in article -->
      <div>
          <ins class="adsbygoogle"
               style="display:block; text-align:center;"
               data-ad-layout="in-article"
               data-ad-format="fluid"
               data-ad-client="ca-pub-1852752964062281"
               data-ad-slot="8435469231"></ins>
          <script>
               (adsbygoogle = window.adsbygoogle || []).push({});
          </script>
      </div>
      <hr>

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right sticky">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-cog"></i> Table of Contents</h4></header>
              <ul class="toc__menu">
  <li><a href="#the-load-imbalanced-problem">The load imbalanced problem</a>
    <ul>
      <li><a href="#problem-description">Problem description</a></li>
      <li><a href="#why-this-could-happen">Why this could happen?</a></li>
    </ul>
  </li>
  <li><a href="#how-to-optimize-the-load-balancing">How to optimize the load balancing?</a>
    <ul>
      <li><a href="#using-ip-mode">Using IP mode</a>
        <ul>
          <li><a href="#network-load-balancer-nlb">Network Load Balancer (NLB)</a></li>
          <li><a href="#application-load-balancer-alb">Application Load Balancer (ALB)</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#are-you-sure-it-is-balanced-lets-have-a-test">Are you sure it is balanced? Let’s have a test!</a>
    <ul>
      <li><a href="#i-tried-to-use-ip-mode-but-the-traffic-still-get-imbalanced">I tried to use IP mode but the traffic still get imbalanced</a></li>
    </ul>
  </li>
  <li><a href="#a-summary-if-you-would-like-to-optimize-the-traffic-imbalanced-when-using-aws-load-balancer-controller">A summary if you would like to optimize the traffic imbalanced when using AWS Load Balancer Controller</a>
    <ul>
      <li><a href="#using-ip-mode-as-register-target-to-prevent-kubernetes-additional-hop">Using IP mode as register target to prevent Kubernetes additional hop</a></li>
      <li><a href="#prevent-to-enable-sticky-session-on-elb">Prevent to enable sticky session on ELB</a></li>
      <li><a href="#equally-distribute-pods-across-availability-zones">Equally distribute Pods across Availability Zones</a></li>
    </ul>
  </li>
  <li><a href="#summary">Summary</a></li>
  <li><a href="#references">References</a></li>
</ul>

            </nav>
          </aside>
        
        <p>This article is sharing the best practice for doing load balancing on Amazon EKS, learn what is advantage and disadvantage of using different controller. We will discuss more detail about the imbalanced problem after applying controller to deploy the Elastic Load Balancer.</p>

<h2 id="the-load-imbalanced-problem">The load imbalanced problem</h2>

<p>Follow the example as mentioned in the previous article, if you deployed a Kubernetes service and noticed the utilization on your backend application is not balanced; or, if you are using AWS Load Balancer controller, Traefik, nginx-ingress controller by finding the Elastic Load Balancer wasn’t correctly separate the loads (when using instance mode to register your Pods as targets), and you may find the imbalanced traffic, that’s the major topic in this article would like to talk about: discuss how to improve and optimize it.</p>

<h3 id="problem-description">Problem description</h3>

<p>Let’s say if I am deploying 4 Pods in my Kubernetes cluster, which is using the default deployment as mentioned below to expose my Kubernetes service:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME                                READY   STATUS    RESTARTS   AGE   IP
nginx-deployment-594764c789-5s668   1/1     Running   0          30m   192.168.42.171
nginx-deployment-594764c789-9k949   1/1     Running   0          30m   192.168.39.194
nginx-deployment-594764c789-b292m   1/1     Running   0          33m   192.168.29.24 
nginx-deployment-594764c789-s226c   1/1     Running   0          30m   192.168.15.158
</code></pre></div></div>

<p>The Kubernetes service:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">nginx-svc</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="m">80</span>
    <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">nginx</span>
</code></pre></div></div>

<p>To better understand the problem I am describing in this post, the application I deployed will response Pod IP address to let us know which one received the request:</p>

<figure class="">
  <img src="/assets/images/posts/2022/04/eks-best-practice-load-balancing/imbalanced-test-result.png" alt="Testing the service and see the response from the backend." />
  
    <figcaption>
      Figure 1. Testing the service and see the response from the backend.

    </figcaption>
  
</figure>

<p>After running a loop and making at least <strong>79 HTTP requests</strong> in my test, I get the following response to know how the load has been distributed:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">192.168.42.171</code>: 12 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.39.194</code>: 33 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.29.24</code>: 23 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.15.158</code>: 10 times</li>
</ul>

<p>According to the testing, we can see the load is not very evenly distributed.</p>

<h3 id="why-this-could-happen">Why this could happen?</h3>

<p>As mentioned in the <a href="/eks-best-practice-load-balancing-1-en">previous post</a>, whether you are defining <code class="language-plaintext highlighter-rouge">externalTrafficPolicy=Cluster</code> or <code class="language-plaintext highlighter-rouge">externalTrafficPolicy=Local</code>, the routing behavior is relying on <code class="language-plaintext highlighter-rouge">iptables</code>(or <code class="language-plaintext highlighter-rouge">ipvs</code>) can be unpredictable. Because it is doing second layer of load balancing, which is totally unnecessary for increasing a hop in AWS VPC.</p>

<p>Elastic Load Balancer in AWS already provides a straightforward solution to balance your loads, and its algorithm will try to distribute the requests to all backend servers as even as possible. Doing load balancing in Kubernetes network generally is increasing the complexity of your architecture, and make traffic can be hard to trace; or, even worse, cause the imbalanced issue as you can observe.</p>

<p>This also makes the load balancing became unpredictable. Although the traffic send to the registered EC2 instance can be evenly distributed; however, it doesn’t mean the load can be separated to Pods as well. You will never know which Pods will be routed due to this load balancing layer implemented by Kubernetes networking.</p>

<p>No matter choose Traefik, nginx-ingress, if you are still following the default load balancing pattern offered by upstream Kubernetes code, then you can expect the traffic can come with load imbalanced.</p>

<h2 id="how-to-optimize-the-load-balancing">How to optimize the load balancing?</h2>

<p>The major problem is the default load balancing behavior can involve the Kubernetes load balancing and add a hop for the traffic. So you may start to wondering how to better resolve this problem; however, there is no specific feature can be adjusted on Kubernetes to remove the default load balancing, but it still could be possible to skip the Kubernetes load balancing and forward the traffic to Pods directly.</p>

<p>If you are running Pods on Amazon EKS and using default AWS VPC CNI Plugin<sup id="fnref:aws-vpc-cni-plugin" role="doc-noteref"><a href="#fn:aws-vpc-cni-plugin" class="footnote" rel="footnote">1</a></sup>, you can expect your Pods should have dedicated secondary private IP address that can be communicated within your AWS VPC network; therefore, it also means that the IP address can be registered to your Elastic Load Balancer as backend target. The flow can be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Client -&gt; NLB (forawrd request to IP target) -&gt; Pod IPs (Reach out to Pods directly)
</code></pre></div></div>

<p>For Application Load Balancer (ALB) and Network Load Balancer (NLB), both provide a feature that you can register backend targets with IP addresses (<a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/network/load-balancer-target-groups.html#target-type">NLB</a>, <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-target-groups.html#target-type">ALB</a>. Note: Classic Load Balancer doesn’t offer this option). We can simply to associate these Pod IP addresses as backend targets instead of using instances. As long as the Pod IP addresses are reachable, it can move the request be forwarded to the backend Pods by skipping the Kubernetes load balancing behavior.</p>

<h3 id="using-ip-mode">Using IP mode</h3>

<p>So how to register Pod IP addresses in Elastic Load Balancer? A seamlessly way is to deploy your Kubernetes service and use AWS Load Balancer Controller<sup id="fnref:aws-load-balancer-controller" role="doc-noteref"><a href="#fn:aws-load-balancer-controller" class="footnote" rel="footnote">2</a></sup> to enable this feature. Instead of using the default Kubernetes controller to deploy your Elastic Load Balancer, using AWS Load Balancer Controller helps you manage load balancer resource including all functionality features and different type of load balancer such as NLB, ALB, both are can be supported by the controller. After installing the AWS Load Balancer on your EKS cluster, you can enable the IP registration type for your Pods by simply adding annotations to the deployment manifests.</p>

<h4 id="network-load-balancer-nlb">Network Load Balancer (NLB)</h4>

<p>Here is a deployment sample that use IP targets with pods deployed to Amazon EC2 nodes. Your Kubernetes service must be created as type <code class="language-plaintext highlighter-rouge">LoadBalancer</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">my-service</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">service.beta.kubernetes.io/aws-load-balancer-type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">external"</span>
    <span class="na">service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</span><span class="pi">:</span> <span class="s2">"</span><span class="s">ip"</span>
  <span class="s">...</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">LoadBalancer</span>
  <span class="s">...</span>
</code></pre></div></div>

<h4 id="application-load-balancer-alb">Application Load Balancer (ALB)</h4>

<p>To deploy application load balancer on Amazon EKS through the AWS Load Balancer Controller, you generally will create an Ingress object in your deployment. With the AWS Load Balancer Controller, it also provides supported annotation that can register pods as targets for the ALB. Traffic reaching the ALB is directly routed to pods for your service. Here is an example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.k8s.io/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Ingress</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">game-2048</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">ingress-2048</span>
  <span class="na">annotations</span><span class="pi">:</span>
    <span class="na">alb.ingress.kubernetes.io/scheme</span><span class="pi">:</span> <span class="s">internet-facing</span>
    <span class="na">alb.ingress.kubernetes.io/target-type</span><span class="pi">:</span> <span class="s">ip</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>In the AWS EKS documentation, it also mentioned detailed guide regarding how to deploy these two load balancers and share an example by using IP target to register your Pods. If you are interested to learn more, please check out to the following documents to get more detail:</p>

<ul>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/network-load-balancing.html">Network load balancing on Amazon EKS</a></li>
  <li><a href="https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html">Application load balancing on Amazon EKS</a></li>
</ul>

<p>By using IP mode, it totally removes the layer of load balancing manipulated by Kubernetes. This generally forward requests to the Pods without doing second forwarding:</p>

<figure class="">
  <img src="/assets/images/posts/2022/04/eks-best-practice-load-balancing/ip-target.png" alt="Register Pods with IP mode" />
  
    <figcaption>
      Figure 2. Register Pods with IP mode

    </figcaption>
  
</figure>

<h2 id="are-you-sure-it-is-balanced-lets-have-a-test">Are you sure it is balanced? Let’s have a test!</h2>

<p>This time I used the same testing strategy as mentioned in the first problem description section and ran four Pods associated with Network Load Balancer using IP mode, which is showing below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>kubectl get pods <span class="nt">-o</span> wide
NAME                                READY   STATUS    RESTARTS   AGE     IP               NODE                                              NOMINATED NODE   READINESS GATES
nginx-deployment-75d48f6698-b5fm7   1/1     Running   0          35m     192.168.17.15    ip-192-168-5-38.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
nginx-deployment-75d48f6698-l4gw5   1/1     Running   0          2m45s   192.168.27.143   ip-192-168-5-38.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
nginx-deployment-75d48f6698-q2q57   1/1     Running   0          41m     192.168.22.126   ip-192-168-5-38.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
nginx-deployment-75d48f6698-x5m25   1/1     Running   0          2m45s   192.168.14.48    ip-192-168-5-38.ap-northeast-1.compute.internal   &lt;none&gt;           &lt;none&gt;
</code></pre></div></div>

<p>After passing at least 50 requests, I can see the request distributions are showing below:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">192.168.17.15</code>: 10 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.27.143</code>: 12 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.22.126</code>: 14 times</li>
  <li><code class="language-plaintext highlighter-rouge">192.168.14.48</code>: 13 times</li>
</ul>

<p>For each target, it nearly have ~25% chances will be routed evenly by the Network Load Balancer. Because it skip the load balancing layer of the Kubernetes, it will follow the routing algorithm<sup id="fnref:routing-algorithm" role="doc-noteref"><a href="#fn:routing-algorithm" class="footnote" rel="footnote">3</a></sup> and separate load evenly as we expected.</p>

<h3 id="i-tried-to-use-ip-mode-but-the-traffic-still-get-imbalanced">I tried to use IP mode but the traffic still get imbalanced</h3>

<p>In my testing, I was running a couple of Pods with nginx image and provided simple web server in my backend. The scenario in this article mentioning generally is describing all targets were using stateless HTTP connections. However, in some cases, it could be possible ELB might unequally route traffic to your targets if:</p>

<ul>
  <li>Clients are routing requests to an incorrect IP address of a load balancer node with a DNS record that has an expired TTL.</li>
  <li>Sticky sessions (session affinity) are enabled for the load balancer. Sticky sessions use cookies to help the client maintain a connection to the same instance over a cookie’s lifetime, which can cause imbalances over time.</li>
  <li>Available healthy instances aren’t evenly distributed across Availability Zones.</li>
  <li>Instances of a specific capacity type aren’t equally distributed across Availability Zones.</li>
  <li>There are long-lived TCP connections between clients and instances.</li>
  <li>The connection uses a WebSocket.</li>
</ul>

<p>Generally speaking, if the client or any configuration can cause sticky session, it still have possibility can get the traffic imbalanced. The detail can refer to the following article on AWS knowledge center:</p>

<ul>
  <li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/elb-fix-unequal-traffic-routing/">Why is Elastic Load Balancing unequally routing my load balancer traffic?</a></li>
</ul>

<p>But overall, using the IP mode to register our Pods, literally can resolve the problem as we described due to the design of Kubernetes service networking.</p>

<h2 id="a-summary-if-you-would-like-to-optimize-the-traffic-imbalanced-when-using-aws-load-balancer-controller">A summary if you would like to optimize the traffic imbalanced when using AWS Load Balancer Controller</h2>

<h3 id="using-ip-mode-as-register-target-to-prevent-kubernetes-additional-hop">Using IP mode as register target to prevent Kubernetes additional hop</h3>

<p>Although Elastic Load Balancer can offer an option to register your targets by instances, however, it generally would be suitable when you are running single service and expose it with a port on a dedicated EC2 instance. With Kubernetes service running on your EC2 instance but exposed as <code class="language-plaintext highlighter-rouge">NodePort</code> service, it can involve multiple Pods behind the service port offered on your instance due to the service load balancing. The packet can be replaced to other destination field of your Pod’s private IP address when the packet flood into the instance through Linux ipvs or iptables rules.</p>

<p>If the service work load is relying on Kubernetes deployment, it is recommended  such as <code class="language-plaintext highlighter-rouge">service.beta.kubernetes.io/aws-load-balancer-nlb-target-type</code> for NLB, <code class="language-plaintext highlighter-rouge">alb.ingress.kubernetes.io/target-type</code> for ALB.</p>

<h3 id="prevent-to-enable-sticky-session-on-elb">Prevent to enable sticky session on ELB</h3>

<p>It is also important to make sure the Elastic Load Balancer won’t stick your client session to specific target<sup id="fnref:aws-elb-sticky-clb" role="doc-noteref"><a href="#fn:aws-elb-sticky-clb" class="footnote" rel="footnote">4</a></sup> <sup id="fnref:aws-elb-sticky-alb" role="doc-noteref"><a href="#fn:aws-elb-sticky-alb" class="footnote" rel="footnote">5</a></sup>. Although Elastic Load Balancer provides cookie-based stickiness session to bind a user’s session to a specific target, which can be achieved by configuring the load balancer attribute and also supported by AWS Load Balancer Controller as below, but to optimize the traffic imbalanced, it is recommended to avoid use the sticky session as it can potentially cause the phenomena.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># ALB</span>
<span class="na">alb.ingress.kubernetes.io/target-group-attributes</span><span class="pi">:</span> <span class="s">stickiness.enabled=true,stickiness.lb_cookie.duration_seconds=60</span>

<span class="c1"># NLB</span>
<span class="na">service.beta.kubernetes.io/aws-load-balancer-target-group-attributes</span><span class="pi">:</span> <span class="s">stickiness.enabled=true,stickiness.type=source_ip</span>
</code></pre></div></div>

<h3 id="equally-distribute-pods-across-availability-zones">Equally distribute Pods across Availability Zones</h3>

<p>As ELB requires to strike the balance between your Availability Zones to ensure the service high availability. This helps your traffic can correctly be separated on all backend target.</p>

<h2 id="summary">Summary</h2>

<p>In this article, it explains the practice of optimizing the load balancing and mitigate the imbalanced traffic problem when deploying service with Kubernetes. This article also brings you an overview and learn what other scenarios that you can potentially find out ELB might unequally route traffic to your backend targets.</p>

<p>In the next article we will review a couple of Kubernetes load balancer controllers that can be deployed on Amazon EKS and see what option can be the best practice for your environment.</p>

<ul>
  <li><a href="/eks-best-practice-load-balancing-1-en">Best practice for load balancing - 1. Let’s start with an example from Kubernetes document</a></li>
  <li><a href="/eks-best-practice-load-balancing-2-en">Best practice for load balancing - 2. imbalanced problem</a></li>
  <li><a href="/eks-best-practice-load-balancing-3-en">Best practice for load balancing - 3. what controller should I use</a></li>
</ul>

<h2 id="references">References</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:aws-vpc-cni-plugin" role="doc-endnote">
      <p><a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html">AWS VPC CNI Plugin</a> <a href="#fnref:aws-vpc-cni-plugin" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:aws-load-balancer-controller" role="doc-endnote">
      <p><a href="https://docs.aws.amazon.com/eks/latest/userguide/aws-load-balancer-controller.html">AWS Load Balancer Controller</a> <a href="#fnref:aws-load-balancer-controller" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:routing-algorithm" role="doc-endnote">
      <p>How Elastic Load Balancing works - <a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/userguide/how-elastic-load-balancing-works.html#routing-algorithm">Routing algorithm</a> <a href="#fnref:routing-algorithm" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:aws-elb-sticky-clb" role="doc-endnote">
      <p><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/classic/elb-sticky-sessions.html">Configure sticky sessions for your Classic Load Balancer</a> <a href="#fnref:aws-elb-sticky-clb" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:aws-elb-sticky-alb" role="doc-endnote">
      <p><a href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/sticky-sessions.html">Sticky sessions for your Application Load Balancer</a> <a href="#fnref:aws-elb-sticky-alb" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="/tags/#alb-ingress-controller" class="page__taxonomy-item" rel="tag">ALB Ingress Controller</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#alb" class="page__taxonomy-item" rel="tag">ALB</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#amazon-web-services" class="page__taxonomy-item" rel="tag">amazon web services</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#amazon" class="page__taxonomy-item" rel="tag">amazon</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#aws-load-balancer-controller" class="page__taxonomy-item" rel="tag">AWS Load Balancer Controller</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#aws" class="page__taxonomy-item" rel="tag">aws</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#ec2" class="page__taxonomy-item" rel="tag">EC2</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#eks" class="page__taxonomy-item" rel="tag">EKS</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#elastic-compute-cloud" class="page__taxonomy-item" rel="tag">Elastic Compute Cloud</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#elastic-kubernetes-service" class="page__taxonomy-item" rel="tag">Elastic Kubernetes Service</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#elastic-load-balancer" class="page__taxonomy-item" rel="tag">Elastic Load Balancer</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#elb" class="page__taxonomy-item" rel="tag">ELB</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#k8s" class="page__taxonomy-item" rel="tag">k8s</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#kubernetes" class="page__taxonomy-item" rel="tag">Kubernetes</a><span class="sep">, </span>
    
      
      
      <a href="/tags/#load-balancer" class="page__taxonomy-item" rel="tag">Load Balancer</a>
    
    </span>
  </p>




        
  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time datetime="2022-04-08T00:00:00-05:00">April 8, 2022</time></p>


      </footer>

      <section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=%5BAWS%5D%5BEKS%5D+Best+practice+for+load+balancing+-+2.+imbalanced+problem%20https%3A%2F%2Feasoncao.com%2Feks-best-practice-load-balancing-2-en%2F" class="btn btn--twitter" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Twitter"><i class="fab fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Feasoncao.com%2Feks-best-practice-load-balancing-2-en%2F" class="btn btn--facebook" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on Facebook"><i class="fab fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3A%2F%2Feasoncao.com%2Feks-best-practice-load-balancing-2-en%2F" class="btn btn--linkedin" onclick="window.open(this.href, 'window', 'left=20,top=20,width=500,height=500,toolbar=1,resizable=0'); return false;" title="Share on LinkedIn"><i class="fab fa-fw fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>


      
      <iframe
        style="width: 100%; max-width: 485px; height: 170px; margin: auto; overflow: hidden; display: block;"
        src="https://button.like.co/in/embed/easoncao/button?referrer=https%3A%2F%2Feasoncao.com%2Feks-best-practice-load-balancing-2-en%2F" frameBorder="0">
      </iframe>
      

      <!-- Buy me a coffee -->
      <section class="page__share">
        <h4 class="page__share-title">Is that useful? Let me know or buy me a coffee</h4>
        <p class="page__meta">這篇內容對你有幫助嗎？</p>
        <a href="https://paypal.me/e4son"><img src="https://cdn.jsdelivr.net/gh/twolfson/paypal-github-button@1.0.0/dist/button.svg" alt="Support via PayPal"></a>
        <a href="https://p.ecpay.com.tw/17C964C" class="btn btn--success">一次性支持 (ECPay)</a>
      </section>


      
  <nav class="pagination">
    
      <a href="/eks-best-practice-load-balancing-1-en/" class="pagination--pager" title="[AWS][EKS] Best practice for load balancing - 1. Let’s start with an example from Kubernetes document
">Previous</a>
    
    
      <a href="/eks-best-practice-load-balancing-3-en/" class="pagination--pager" title="[AWS][EKS] Best practice for load balancing - 3. what controller should I use
">Next</a>
    
  </nav>

    </div>

    
      <div class="page__comments">
  
  
      <h4 class="page__comments-title">Leave a comment</h4>
      <section id="disqus_thread"></section>
    
</div>

    
  </article>

  

  <!-- Google Adsense -->
  <div class="page__related">
    <h4 class="page__related-title">You May Also Have Interest</h4>
    <div>
        <!-- responsive ad -->
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-1852752964062281"
             data-ad-slot="2849626059"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
  </div>

  
    <div class="page__related">
      <h4 class="page__related-title">You may also enjoy</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/posts/2023/04/five-years-at-amazon-as-cloud-support-engineer-in-aws/cover.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/five-years-at-amazon-as-cloud-support-engineer-in-aws/" rel="permalink">身處 Amazon 工作 5 年學到的事：在 AWS 擔任 Cloud Support Engineer 是什麼樣的體驗
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">2023 是我在 AWS 擔任 Cloud Support Engineer 的第六年，這份工作對我來說某種程度上是又愛又恨。作為見證 AWS 中文技術支援團隊的一員，五年時間說長不長，說短也不短，卻有非常多學習和體悟。
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/posts/2023/03/aws-cloud-support-engineer-interview-tips-and-required-skills/cover.jpg" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/aws-cloud-support-engineer-interview-tips-and-required-skills/" rel="permalink">在 AWS Cloud Support Engineer 面試中脫穎而出：必備的技術能力和重要特質
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  2 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">如果你正準備面試 AWS Cloud Support Engineer 的職位，在這篇文章中，我將與你分享我對於 AWS Cloud Support Engineer 所需的必備技能和特質，幫助你更好地了解這份職位且思考自己目前所具備的能力是與該團隊所交集，讓你在面試中脫穎而出。
</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/eks-aws-load-balancer-controller-v1-to-v2-migration-behavior/" rel="permalink">[AWS] 那些沒寫在文件上的事 - AWS Load Balancer Controller v1 升級至 v2
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  3 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">隨著 Amazon EKS 對於 Kubernetes 1.22 的推出，1.21 也預計於 February 15, 2023 在 Amazon EKS 終止支援 1，對於 AWS Load Balancer Controller 仍然使用舊版本的用戶來說，勢必面臨需要升級 AWS Load Balancer ...</p>
  </article>
</div>

        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork">
    
      <div class="archive__item-teaser">
        <img src="/assets/images/posts/2020/10/zero-downtime-deployment-when-using-alb-ingress-controller/deployment-workflow-alb-ingress-controller-4-side-note-of-deregister.png" alt="">
      </div>
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      
        <a href="/zero-downtime-deployment-when-using-alb-ingress-controller-on-amazon-eks-and-prevent-502-error/" rel="permalink">[AWS][EKS] Zero downtime deployment(RollingUpdate) when using AWS Load Balancer Controller on Amazon EKS
</a>
      
    </h2>
    
      <p class="page__meta"><i class="far fa-clock" aria-hidden="true"></i> 




  22 minute read

</p>
    
    <p class="archive__item-excerpt" itemprop="description">This article is describing the thing you need to aware when using ALB Ingress Controller (AWS Load Balancer Controller) to do deployment and prevent 502 erro...</p>
  </article>
</div>

        
      </div>
    </div>
  
  
</div>

    </div>

    
      <div class="search-content">
        <div class="search-content__inner-wrap"><form class="search-content__form" onkeydown="return event.key != 'Enter';">
    <label class="sr-only" for="search">
      Enter your search term...
    </label>
    <input type="search" id="search" class="search-input" tabindex="-1" placeholder="Enter your search term..." />
  </form>
  <div id="results" class="results"></div></div>

      </div>
    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->



<div id="footer-subscribe-email-list">
    <h3>Get the updates </h3>
    <form action="https://docs.google.com/forms/d/e/1FAIpQLSfuofCYvu2cV614aDt6SO5ua_5trT0EC5yeSJObLY0KGjFtvQ/formResponse" method="POST">
        <div style="display: flex;">
            <!-- input name="entry.205499253" type="text" id="Name" class="form-control" placeholder="Name" -->
            <input name="entry.1288273007" type="email" id="email" class="form-control" placeholder="Email" required="required" style="margin-top: 2px; margin-right: 5px; width: 50%;">
            <input class="btn btn--primary" id="subscribe" type="submit" value="訂閱 (Sign Up)" style="width: 30%;">
        </div>
    </form>
</div>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8GPCXJPGFZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8GPCXJPGFZ');
</script>
<!-- end custom footer snippets -->

        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    

    
      
        
      
        
          <li><a href="https://facebook.com/EasonTechTalk" rel="nofollow noopener noreferrer"><i class="fab fa-fw fa-facebook-square" aria-hidden="true"></i> Facebook</a></li>
        
      
        
      
        
      
        
      
        
      
    

    <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    <li><a href="/sitemap.xml"><i class="fas fa-fw fa-sitemap" aria-hidden="true"></i> SiteMap</a></li>
    <li><a href="/tags"><i class="fas fa-fw fa-tags" aria-hidden="true"></i> Tags</a></li>
    <li><a href="https://toolbox.easoncao.com/"><i class="fas fa-fw fa-toolbox" aria-hidden="true"></i> ToolBox</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2023 Continuous Improvement. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>




<script src="/assets/js/lunr/lunr.min.js"></script>
<script src="/assets/js/lunr/lunr-store.js"></script>
<script src="/assets/js/lunr/lunr-en.js"></script>




  <script>
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-80058083-2']);
  
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>






    
  <script>
    var disqus_config = function () {
      this.page.url = "https://easoncao.com/eks-best-practice-load-balancing-2-en/";  /* Replace PAGE_URL with your page's canonical URL variable */
      this.page.identifier = "/eks-best-practice-load-balancing-2-en"; /* Replace PAGE_IDENTIFIER with your page's unique identifier variable */
    };
    (function() { /* DON'T EDIT BELOW THIS LINE */
      var d = document, s = d.createElement('script');
      s.src = 'https://lenlabs.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  





  </body>
</html>
